---
/**
 * Programs Page - EDI McGill
 *
 * Landing page for Events & Workshops
 * Displays upcoming and past events + auto-includes blog posts with category "Events & Workshops"
 */
import BaseLayout from '@/layouts/BaseLayout'
import TitlePage from '@/components/TitlePage'
import { getCollection } from 'astro:content'
import PostCard from '@/components/PostCard'
import { Image } from 'astro:assets'
import FormattedDate from '@/components/FormattedDate'

const title = 'Programs & Events'
const description = 'Explore EDI workshops, events, and learning opportunities at McGill University'

// Fetch events from the events collection
let upcomingEvents: any[] = []
let pastEvents: any[] = []

try {
	const allEvents = await getCollection('events', ({ data }) => !data.draft)
	const now = new Date()

	// Sort events by date
	upcomingEvents = allEvents
		.filter((event) => event.data.eventDate && new Date(event.data.eventDate) >= now)
		.sort((a, b) => new Date(a.data.eventDate!).getTime() - new Date(b.data.eventDate!).getTime())

	pastEvents = allEvents
		.filter((event) => !event.data.eventDate || new Date(event.data.eventDate) < now)
		.sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
} catch (error) {
	console.log('Events collection not yet populated')
}

// Auto-fetch blog posts with category "Events & Workshops"
let programPosts: any[] = []
try {
	const allBlogPosts = await getCollection('blog', ({ data }) => !data.draft)
	programPosts = allBlogPosts
		.filter((post) => post.data.category === 'Events & Workshops')
		.sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())
} catch (error) {
	console.log('Error fetching blog posts:', error)
}
---

<BaseLayout title={title} description={description}>
	<!-- Page header with accent line -->
	<div class='mb-8'>
		<h1 class='text-2xl md:text-3xl font-semibold mb-4 leading-snug' style='color: #111827;'>
			{title}
		</h1>

		<!-- Description with accent line - vibrant colors -->
		<div class='flex items-start gap-3'>
			<div
				class='w-1 h-auto min-h-[60px] rounded-full flex-shrink-0'
				style='background: linear-gradient(to bottom, #E05A1A, #F2C94C);'
			>
			</div>
			<div class='flex-1'>
				<p class='text-base leading-loose' style='color: #374151;'>
					Join us for engaging workshops, seminars, and events designed to promote equity,
					diversity, and inclusion at McGill. Learn, connect, and make a difference.
				</p>
			</div>
		</div>
	</div>

	{
		upcomingEvents.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 dark:text-white'>Upcoming Events</h2>
				<div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'>
					{upcomingEvents.map((event) => (
						<PostCard post={event} />
					))}
				</div>
			</section>
		)
	}

	{
		pastEvents.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 dark:text-white'>Past Events</h2>
				<div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'>
					{pastEvents.map((event) => (
						<PostCard post={event} />
					))}
				</div>
			</section>
		)
	}

	<!-- Auto-generated tiles from blog posts with category "Events & Workshops" -->
	{
		programPosts.length > 0 && (
			<section class='mb-12'>
				<h2 class='text-2xl font-bold mb-6 dark:text-white'>Program Highlights</h2>
				<div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'>
					{programPosts.map((post) => (
						<a
							href={`/post/${post.slug}`}
							class='group bg-white dark:bg-gray-900 border-2 border-gray-200 dark:border-gray-700 rounded-xl overflow-hidden hover:border-blue-500 dark:hover:border-blue-400 transition-all hover:shadow-2xl hover:-translate-y-2'
						>
							<div class='aspect-video overflow-hidden'>
								<Image
									src={post.data.heroImage}
									alt={post.data.title}
									width={400}
									height={300}
									class='w-full h-full object-cover group-hover:scale-110 transition-transform duration-300'
								/>
							</div>
							<div class='p-6'>
								<div class='flex items-center gap-3 mb-3'>
									<span class='px-3 py-1 rounded-lg text-xs font-bold bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'>
										Programs
									</span>
									<FormattedDate date={post.data.pubDate} class='text-sm' />
								</div>
								<h3 class='text-lg font-bold mb-3 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors'>
									{post.data.title}
								</h3>
								<p class='text-gray-600 dark:text-gray-400 text-sm line-clamp-2'>
									{post.data.description}
								</p>
								<div class='mt-4 text-blue-600 dark:text-blue-400 font-semibold text-sm group-hover:translate-x-2 transition-transform inline-block'>
									Learn more â†’
								</div>
							</div>
						</a>
					))}
				</div>
			</section>
		)
	}

	{
		upcomingEvents.length === 0 && pastEvents.length === 0 && programPosts.length === 0 && (
			<div class='text-center py-12 text-gray-600 dark:text-gray-400'>
				<p class='text-lg'>No events currently scheduled. Check back soon for updates!</p>
			</div>
		)
	}
</BaseLayout>
