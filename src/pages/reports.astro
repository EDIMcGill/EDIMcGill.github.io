---
/**
 * Reports Page - EDI McGill
 *
 * EDI research, annual reports, and data
 */
import BaseLayout from '@/layouts/BaseLayout'
import TitlePage from '@/components/TitlePage'
import { getCollection } from 'astro:content'
import PostCard from '@/components/PostCard'
import { Image } from 'astro:assets'
import FormattedDate from '@/components/FormattedDate'

const title = 'Reports & Research'
const description = 'Access EDI reports, research, and data from McGill University'

// Fetch reports from both the reports collection and blog posts
let reports: any[] = []
let reportsByYear: Record<number, any[]> = {}
let reportBlogPosts: any[] = []

try {
	// Fetch from reports collection
	const reportsCollection = await getCollection('reports', ({ data }) => !data.draft).catch(
		() => []
	)

	// Fetch blog posts that are categorized as reports/research
	const blogPosts = await getCollection('blog', ({ data }) => !data.draft).catch(() => [])
	reportBlogPosts = blogPosts
		.filter(
			(post) =>
				post.data.category === 'Reports & Research' ||
				post.data.category === 'Research' ||
				post.data.category === 'Reports'
		)
		.sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime())

	// Combine both sources
	const allReports = [
		...reportsCollection.map((r) => ({ ...r, collection: 'reports' })),
		...reportBlogPosts.map((r) => ({ ...r, collection: 'blog' }))
	]

	// Sort by date
	reports = allReports.sort(
		(a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
	)

	// Group by year
	reports.forEach((report) => {
		const year = report.data.reportYear || new Date(report.data.pubDate).getFullYear()
		if (!reportsByYear[year]) {
			reportsByYear[year] = []
		}
		reportsByYear[year].push(report)
	})
} catch (error) {
	console.log('Reports collection not yet populated')
}

const years = Object.keys(reportsByYear)
	.map(Number)
	.sort((a, b) => b - a)
---

<BaseLayout title={title} description={description}>
	<!-- Page header with accent line -->
	<div class='mb-8'>
		<h1 class='text-2xl md:text-3xl font-semibold mb-4 leading-snug' style='color: #111827;'>
			{title}
		</h1>

		<!-- Description with accent line - vibrant colors -->
		<div class='flex items-start gap-3'>
			<div
				class='w-1 h-auto min-h-[60px] rounded-full flex-shrink-0'
				style='background: linear-gradient(to bottom, #F2C94C, #5B2D8B);'
			>
			</div>
			<div class='flex-1'>
				<p class='text-base leading-loose' style='color: #374151;'>
					This page curates research, institutional reports, and data related to equity, diversity,
					and inclusion at McGill. Together, these resources offer evidence-based perspectives that
					inform EDI understanding, discussion, and decision-making across the university.
				</p>
			</div>
		</div>
	</div>

	<!-- Featured Reports Section - Vibrant playcard (purple theme for reports) -->
	{
		reportBlogPosts.length > 0 && (
			<div
				class='rounded-2xl p-1.5 mb-6 -mx-5 sm:-mx-8 md:-mx-0'
				style='background: linear-gradient(135deg, rgba(107, 63, 160, 0.20), rgba(107, 63, 160, 0.12)); box-shadow: 0 10px 32px rgba(107, 63, 160, 0.32), 0 0 0 1px rgba(107, 63, 160, 0.14);'
			>
				<div class='rounded-xl p-6 md:p-8' style='background: rgba(255, 255, 255, 0.65);'>
					<div class='flex items-start gap-2 mb-3'>
						<div
							class='w-1 h-6 rounded-full flex-shrink-0 mt-1'
							style='background: linear-gradient(to bottom, #6B3FA0, #E94F88);'
						/>
						<h2 class='text-lg md:text-xl font-semibold leading-relaxed' style='color: #111827;'>
							Research & Reports
						</h2>
					</div>
					<p class='text-sm mb-6 leading-loose' style='color: #374151;'>
						Evidence-based research and institutional reports on EDI at McGill.
					</p>
					<div class='grid grid-cols-1 md:grid-cols-2 gap-6'>
						{reportBlogPosts.map((post) => (
							<a
								href={`/post/${post.slug}`}
								class='group bg-white dark:bg-gray-800/50 rounded-xl overflow-hidden hover:bg-gray-50 dark:hover:bg-gray-800/70 transition-colors'
								style='box-shadow: 0 6px 18px rgba(107, 63, 160, 0.15);'
							>
								<div class='aspect-[16/10] overflow-hidden'>
									<Image
										src={post.data.heroImage}
										alt={post.data.title}
										width={600}
										height={375}
										class='w-full h-full object-cover group-hover:scale-105 transition-transform duration-500'
									/>
								</div>
								<div class='p-5'>
									<div class='flex items-center gap-3 mb-2'>
										<span
											class='px-3 py-1 rounded-lg text-xs font-medium'
											style='background: rgba(107, 63, 160, 0.15); color: #6B3FA0;'
										>
											Reports
										</span>
										<FormattedDate date={post.data.pubDate} class='text-xs' />
									</div>
									<h3
										class='text-base md:text-lg font-semibold mb-2 leading-snug'
										style='color: #1F2937;'
									>
										{post.data.title}
									</h3>
									<p class='text-sm line-clamp-3 leading-relaxed' style='color: #5F6368;'>
										{post.data.description}
									</p>
									<div
										class='mt-3 text-sm inline-block no-underline group-hover:underline font-medium'
										style='color: #6B3FA0; text-decoration-color: rgba(107, 63, 160, 0.3);'
									>
										Read more
									</div>
								</div>
							</a>
						))}
					</div>
				</div>
			</div>
		)
	}

	{
		years.length > 0 && (
			<div class='space-y-12'>
				{years.map((year) => (
					<section>
						<h2 class='text-2xl font-bold mb-6 dark:text-white'>{year} Reports</h2>
						<div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'>
							{reportsByYear[year].map((report) => (
								<PostCard
									post={report}
									slug={
										report.collection === 'blog'
											? `/post/${report.slug}`
											: `/reports/${report.slug}`
									}
								/>
							))}
						</div>
					</section>
				))}
			</div>
		)
	}
</BaseLayout>

<style>
	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>
